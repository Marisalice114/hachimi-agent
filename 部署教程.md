# Hachimi Agent 后端部署指南

## 项目概述

本项目是一个基于 Spring Boot 3.4.5 的智能对话代理系统，集成了多个功能模块：
- Spring AI 框架
- MCP (Model Context Protocol) 服务器支持
- PostgreSQL + PgVector 向量数据库
- 百度地图 MCP 服务器
- 多数据源配置

## 部署架构

```
微信云托管 (Docker容器)
├── Spring Boot 应用 (端口: 8123)
├── Node.js + npm (百度地图MCP服务器)
└── 外部依赖
    ├── 阿里云 RDS PostgreSQL (向量数据库)
    └── MySQL (聊天记录存储)
```

## 部署前准备

### 1. 项目结构
```
hachimi-agent/
├── pom.xml
├── src/
└── target/
    └── hachimi-agent-0.0.1-SNAPSHOT.jar
```

### 2. 构建应用
```bash
# 在项目根目录执行
mvn clean package -DskipTests
```

### 3. 准备部署包
创建部署目录结构：
```
wechat-deploy/
├── Dockerfile
└── hachimi-agent-0.0.1-SNAPSHOT.jar
```

## Docker 配置

### Dockerfile
```dockerfile
# 微信云托管 - JAR包部署方案
FROM amazoncorretto:21-alpine

# 设置时区
RUN apk add --no-cache tzdata && \
    cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone

# 安装 Node.js 和 npm
RUN apk add --no-cache nodejs npm

# 安装百度地图 MCP 服务器包
RUN npm install -g @baidumap/mcp-server-baidu-map

WORKDIR /app

# 复制主应用JAR文件
COPY hachimi-agent-0.0.1-SNAPSHOT.jar app.jar

# 暴露端口
EXPOSE 8123

# 设置 JVM 参数
ENV JAVA_OPTS="-Xms${JVM_XMS:-512m} -Xmx${JVM_XMX:-1024m} -XX:+UseG1GC -XX:+UseContainerSupport -Dfile.encoding=UTF-8"

# 启动应用
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar --spring.profiles.active=prod"]
```

## 数据库配置

### 1. 阿里云 RDS PostgreSQL 配置

#### 白名单设置
1. 登录阿里云控制台
2. 进入 RDS PostgreSQL 实例控制台
3. 选择 **数据安全性** > **白名单设置**
4. 添加微信云托管的出口IP到白名单

**临时测试方案**（仅限测试环境）：
```
0.0.0.0/0  # 允许所有IP访问（生产环境请使用具体IP段）
```

#### 数据库连接信息
```properties
# application-prod.properties
spring.datasource.url=jdbc:postgresql://rm-cn-w5g4cx7e400027ao.rwlb.rds.aliyuncs.com:5432/hachimi_agent
spring.datasource.username=${DB_USERNAME}
spring.datasource.password=${DB_PASSWORD}
```

### 2. MySQL 配置
```properties
# 第二个数据源配置
spring.second-datasource.url=jdbc:mysql://your-mysql-host:3306/your_db
spring.second-datasource.username=${MYSQL_USERNAME}
spring.second-datasource.password=${MYSQL_PASSWORD}
```

## MCP 服务器配置

### 百度地图 MCP 服务器
项目使用 MCP (Model Context Protocol) 集成百度地图服务。

#### 配置文件示例
```json
{
  "mcpServers": {
    "baidu-map": {
      "command": "npx",
      "args": [
        "-y",
        "@baidumap/mcp-server-baidu-map"
      ],
      "env": {
        "BAIDU_MAP_API_KEY": "YOUR_BAIDU_MAP_API_KEY"
      }
    }
  }
}
```

## 微信云托管部署

### 1. 环境变量配置
在微信云托管控制台配置以下环境变量：

| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| `DB_USERNAME` | PostgreSQL用户名 | `your_pg_username` |
| `DB_PASSWORD` | PostgreSQL密码 | `your_pg_password` |
| `MYSQL_USERNAME` | MySQL用户名 | `your_mysql_username` |
| `MYSQL_PASSWORD` | MySQL密码 | `your_mysql_password` |
| `BAIDU_MAP_API_KEY` | 百度地图API密钥 | `S9vBNqPqglOJtJbmFEA9v3ucymHhgpyN` |

### 2. 容器配置
- **CPU**: 1核
- **内存**: 2G
- **端口**: 8123
- **健康检查路径**: `/actuator/health`（如果启用了Actuator）

### 3. 部署流程
1. 压缩部署包 (`wechat-deploy` 目录)
2. 上传到微信云托管
3. 创建新版本
4. 部署并启动服务

## 常见问题解决

### 1. 端口占用问题
**错误**: `Port 8123 was already in use`

**解决方案**:
```bash
# 查找占用端口的进程
netstat -ano | findstr :8123
# 停止进程
taskkill /PID <PID> /F
```

### 2. 数据库连接超时
**错误**: `Connection attempt timed out`

**解决方案**:
1. 检查数据库白名单配置
2. 确认网络连通性
3. 验证数据库用户名密码

### 3. MCP服务器启动失败
**错误**: `Cannot run program "npx"`

**解决方案**:
1. 确保Dockerfile中正确安装了Node.js和npm
2. 检查MCP服务器包是否正确安装
3. 验证npm全局包路径

### 4. Bean创建失败
**错误**: `Error creating bean with name 'myKeyWordEnricher'`

**解决方案**:
修改Bean类，移除条件注解或使用可选依赖：
```java
@Service  // 移除 @ConditionalOnBean
public class MyKeyWordEnricher {
    // Bean实现
}
```

## 部署验证

### 1. 应用启动检查
查看启动日志，确认以下组件正常初始化：
- ✅ Spring Boot应用启动
- ✅ 数据库连接成功
- ✅ MCP服务器连接成功
- ✅ 向量数据库初始化完成

### 2. 健康检查
访问应用健康检查端点：
```
https://your-domain.sh.run.tcloudbase.com/actuator/health
```

### 3. 功能测试
- 测试聊天对话功能
- 验证数据库读写操作
- 检查MCP服务器调用

## 日志监控

### 关键日志信息
```log
# 成功启动的日志特征
Started HachimiAgentApplication in X.XXX seconds
Server response with Protocol: 2024-11-05
{dataSource-1} inited
PgVectorStore已有数据，跳过初始化
```

### 错误日志排查
1. **数据库连接错误**: 检查连接字符串和认证信息
2. **MCP服务器错误**: 检查npm包安装和命令路径
3. **内存不足**: 调整JVM参数或增加容器内存

## 安全建议

### 1. 数据库安全
- 使用具体的IP白名单替代 `0.0.0.0/0`
- 定期更换数据库密码
- 启用数据库审计日志

### 2. 应用安全
- 定期更新依赖版本
- 配置适当的CORS策略
- 启用HTTPS访问

### 3. 环境变量管理
- 不在代码中硬编码敏感信息
- 使用微信云托管的环境变量功能
- 定期轮换API密钥

## 性能优化

### 1. JVM调优
```bash
# 根据容器内存调整JVM参数
JAVA_OPTS="-Xms512m -Xmx1500m -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
```

### 2. 数据库连接池
```properties
# Druid连接池优化
spring.datasource.druid.initial-size=5
spring.datasource.druid.max-active=20
spring.datasource.druid.max-wait=60000
```

### 3. 缓存配置
- 启用Spring Boot缓存
- 配置Redis缓存（如果需要）
- 优化数据库查询

## 版本更新流程

1. **本地测试**: 确保新版本在本地环境正常运行
2. **构建新包**: `mvn clean package -DskipTests`
3. **准备部署包**: 更新JAR文件和配置
4. **部署测试**: 在测试环境验证功能
5. **生产部署**: 创建新版本并发布
6. **监控验证**: 检查应用运行状态和日志

---

**注意**: 本文档基于实际部署经验编写，具体配置可能需要根据实际环境进行调整。